// Wait for Puter.js to load
window.addEventListener('puter-ready', () => {
  console.log("Puter.js ready â€” Nova AI fully armed ðŸ”¥");

  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");

  function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = `message ${type}`;

    if (content instanceof HTMLImageElement) {
      // Real generated image from Puter.js
      content.alt = "Generated by Nova AI with FLUX";
      content.loading = "lazy";
      content.style.maxWidth = "100%";
      content.style.borderRadius = "12px";
      content.style.marginTop = "10px";
      content.style.boxShadow = "0 4px 16px rgba(0,0,0,0.6)";
      div.appendChild(content);
    } else if (typeof content === "string") {
      div.innerText = content;
    }

    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";

    // Better detection: any prompt with gen words = image request
    const lowerText = text.toLowerCase();
    const isImageRequest = lowerText.includes("generate") || 
                           lowerText.includes("genrate") || // catch typos
                           lowerText.includes("create") || 
                           lowerText.includes("draw") || 
                           lowerText.includes("image") || 
                           lowerText.includes("picture") || 
                           lowerText.includes("photo") || 
                           lowerText.includes("banner") ||
                           lowerText.includes("kingdom"); // temp for your test

    if (isImageRequest) {
      // Loading message
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot";
      loadingDiv.innerText = "Generating your image with FLUX.1-schnell... ðŸ”¥ (5-20 sec)";
      chatArea.appendChild(loadingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      // Generate with fast FLUX model
      puter.ai.txt2img(text, {
        model: "black-forest-labs/FLUX.1-schnell"
      })
      .then((imageElement) => {
        chatArea.removeChild(loadingDiv);
        addMessage(imageElement, "bot");
      })
      .catch((err) => {
        chatArea.removeChild(loadingDiv);
        console.error(err);
        addMessage("Generation failed bro â€” bad prompt or temp issue. Try simpler prompt!", "bot");
      });

    } else {
      // Normal chat reply
      addMessage("Hey! I'm Nova AI ðŸš€ Edge computing + ultra-low latency specialist.\nNow with real FLUX image gen. Try: 'generate a cyberpunk kingdom banner'", "bot");
    }
  }

  // Events
  sendBtn.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Intro
  addMessage("Yo bro! I'm Nova AI.\nSpecialist in edge computing, low-latency systems, and generating fire images with FLUX.\nTry: 'generate a futuristic cyberpunk kingdom'", "bot");

  input.focus();
});