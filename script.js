// Wait for Puter.js to be fully ready
window.addEventListener('puter-ready', () => {
  console.log("Puter.js ready â€” Nova AI online ðŸš€");

  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");

  function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = `message ${type}`;

    if (content instanceof HTMLImageElement) {
      // It's a real generated image element from Puter.js
      content.alt = "Generated by Nova AI with FLUX";
      content.style.maxWidth = "100%";
      content.style.borderRadius = "12px";
      content.style.marginTop = "8px";
      content.style.boxShadow = "0 4px 12px rgba(0,0,0,0.5)";
      div.appendChild(content);
    } else if (typeof content === "string") {
      div.innerText = content;
    }

    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";

    const lowerText = text.toLowerCase();
    const isImageRequest = /generate|image|draw|picture|photo|create|flux|kingdom/i.test(lowerText);

    if (isImageRequest) {
      // Show loading
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot";
      loadingDiv.innerText = "Generating with FLUX.1-schnell... ðŸ”¥ (takes 5-15 sec)";
      chatArea.appendChild(loadingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      // Generate real image with FLUX (fast & high quality)
      puter.ai.txt2img(text, {
        model: "black-forest-labs/FLUX.1-schnell"
        // Try "black-forest-labs/FLUX.1-pro" for even better quality (slower)
      })
      .then((imageElement) => {
        chatArea.removeChild(loadingDiv);
        addMessage(imageElement, "bot");
      })
      .catch((err) => {
        chatArea.removeChild(loadingDiv);
        console.error(err);
        addMessage("Generation failed â€” try again or simpler prompt bro ðŸ˜…", "bot");
      });

    } else {
      // Normal text reply
      addMessage("Yo! I'm Nova AI ðŸš€ I specialize in edge computing, low-latency systems, and generating insane images with FLUX.\n\nTry: 'generate a cyberpunk kingdom at sunset'", "bot");
    }
  }

  // Events
  sendBtn.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Intro message
  addMessage("Hey bro! I'm Nova AI.\nReady to generate fire images with FLUX. Try: 'generate a majestic kingdom in the clouds'", "bot");

  // Focus input
  input.focus();
});