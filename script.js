const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const chatArea = document.getElementById("chatArea");

// Sidebar for topics
const sidebar = document.createElement('div');
sidebar.id = "sidebar";
sidebar.style.width = "280px";
sidebar.style.background = "#f8f9fa";
sidebar.style.borderRight = "1px solid #ddd";
sidebar.style.padding = "20px";
sidebar.style.overflowY = "auto";
sidebar.style.position = "fixed";
sidebar.style.left = "0";
sidebar.style.top = "0";
sidebar.style.bottom = "0";
sidebar.style.display = "none"; // mobile hidden by default
document.body.appendChild(sidebar);

// Add toggle button
const toggleBtn = document.createElement('button');
toggleBtn.textContent = "â˜°";
toggleBtn.style.position = "fixed";
toggleBtn.style.left = "10px";
toggleBtn.style.top = "10px";
toggleBtn.style.zIndex = "1000";
toggleBtn.style.padding = "10px";
toggleBtn.style.background = "#007bff";
toggleBtn.style.color = "white";
toggleBtn.style.border = "none";
toggleBtn.style.borderRadius = "8px";
toggleBtn.style.cursor = "pointer";
toggleBtn.onclick = () => {
  sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
};
document.body.appendChild(toggleBtn);

let chats = []; // Array of { id, topic, messages, imageCount, messageCount }
let currentChatId = null;

let isPro = false;

const MAX_IMAGES_FREE = 5;
const MAX_MESSAGES_FREE = 25;

// Load all data
function loadData() {
  const saved = localStorage.getItem("novaHoyaAI_chats");
  if (saved) {
    chats = JSON.parse(saved);
    isPro = localStorage.getItem("novaHoyaAI_pro") === "true";

    if (chats.length > 0) {
      loadChat(chats[0].id); // load latest
    } else {
      newChat();
    }
  } else {
    newChat();
  }
  updateSidebar();
  updateProStatus();
}
loadData();

// New chat
function newChat() {
  const newId = Date.now();
  const newChat = {
    id: newId,
    topic: "New Chat",
    messages: [],
    imageCount: 0,
    messageCount: 0
  };
  chats.unshift(newChat); // add to top
  loadChat(newId);
  saveAll();
  updateSidebar();
}

// Load specific chat
function loadChat(id) {
  const chat = chats.find(c => c.id === id);
  if (!chat) return;

  currentChatId = id;
  chatArea.innerHTML = "";
  chat.messages.forEach(msg => {
    const div = document.createElement("div");
    div.className = `message ${msg.type}`;
    div.innerHTML = msg.content;
    chatArea.appendChild(div);
  });
  chatArea.scrollTop = chatArea.scrollHeight;

  // Update topic in sidebar
  document.querySelectorAll('.topic-item').forEach(item => {
    item.style.fontWeight = item.dataset.id == id ? "bold" : "normal";
    item.style.background = item.dataset.id == id ? "#e3f2fd" : "transparent";
  });
}

// Update sidebar topics
function updateSidebar() {
  sidebar.innerHTML = `
    <h3 style="margin-bottom: 20px; color: #007bff;">NovaHoyaAI Chats</h3>
    <button id="newChatBtn" style="width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 8px; margin-bottom: 20px; cursor: pointer;">
      + New Chat
    </button>
    <div id="topicsList"></div>
  `;

  const list = sidebar.querySelector('#topicsList');
  chats.forEach(chat => {
    const item = document.createElement('div');
    item.className = "topic-item";
    item.dataset.id = chat.id;
    item.textContent = chat.topic || "New Chat";
    item.style.padding = "10px";
    item.style.borderRadius = "8px";
    item.style.marginBottom = "5px";
    item.style.cursor = "pointer";
    item.onclick = () => loadChat(chat.id);
    list.appendChild(item);
  });

  document.getElementById('newChatBtn').onclick = newChat;
}

// Generate topic from first user message
function generateTopic(text) {
  const words = text.trim().split(" ").slice(0, 6).join(" ");
  return words || "New Chat";
}

// Save all
function saveAll() {
  localStorage.setItem("novaHoyaAI_chats", JSON.stringify(chats));
  localStorage.setItem("novaHoyaAI_pro", isPro);
}

// Your addMessage (updated to save)
function addMessage(content, type) {
  const div = document.createElement("div");
  div.className = `message ${type}`;

  if (content instanceof HTMLImageElement) {
    content.alt = "Generated by NovaHoyaAI" + (isPro ? " Pro ðŸ”¥" : "");
    content.loading = "lazy";
    content.style.maxWidth = "100%";
    content.style.borderRadius = "12px";
    content.style.marginTop = "10px";
    content.style.boxShadow = "0 4px 12px rgba(0,0,0,0.5)";
    div.appendChild(content);
  } else if (typeof content === "string") {
    if (content.startsWith("http") || content.startsWith("data:image")) {
      const img = document.createElement("img");
      img.src = content;
      img.alt = "Generated by NovaHoyaAI" + (isPro ? " Pro ðŸ”¥" : "");
      img.loading = "lazy";
      img.style.maxWidth = "100%";
      img.style.borderRadius = "12px";
      img.style.marginTop = "10px";
      div.appendChild(img);
    } else {
      if (isPro && type === "bot" && Math.random() < 0.4) {
        content += " (NovaHoyaAI Pro ðŸ”¥)";
      }
      div.innerText = content;
    }
  }

  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;

  // Save to current chat
  const currentChat = chats.find(c => c.id === currentChatId);
  if (currentChat) {
    currentChat.messages.push({ content: div.innerHTML, type });
    if (currentChat.messages.length === 2 && type === "user") { // first user message
      currentChat.topic = generateTopic(content);
      updateSidebar();
    }
    saveAll();
    updateProStatus();
  }
}

// Your sendMessage (with limits)
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  const currentChat = chats.find(c => c.id === currentChatId);
  if (!currentChat) return;

  if (!isPro && currentChat.messageCount >= MAX_MESSAGES_FREE) {
    addMessage(`Message limit reached (${MAX_MESSAGES_FREE}). Win Pro in Discord for unlimited!`, "bot");
    return;
  }

  addMessage(text, "user");
  input.value = "";
  currentChat.messageCount++;

  const lowerText = text.toLowerCase();
  const isImageRequest = lowerText.includes("generate") || lowerText.includes("create") || 
                         lowerText.includes("draw") || lowerText.includes("image") || 
                         lowerText.includes("picture") || lowerText.includes("logo");

  if (isImageRequest) {
    if (!isPro && currentChat.imageCount >= MAX_IMAGES_FREE) {
      addMessage(`Image limit reached (${MAX_IMAGES_FREE}). Win Pro in Discord!`, "bot");
      return;
    }

    const loadingDiv = document.createElement("div");
    loadingDiv.className = "message bot";
    loadingDiv.innerText = isPro ? "Generating Pro image... ðŸ”¥ðŸ”¥" : "Generating image... ðŸ”¥";
    chatArea.appendChild(loadingDiv);
    chatArea.scrollTop = chatArea.scrollHeight;

    try {
      const imageElement = await puter.ai.txt2img(text, {
        model: "black-forest-labs/FLUX.1-schnell"
      });
      chatArea.removeChild(loadingDiv);
      addMessage(imageElement, "bot");
      currentChat.imageCount++;
    } catch (err) {
      chatArea.removeChild(loadingDiv);
      addMessage("Image gen failed â€” try again!", "bot");
    }
  } else {
    // GPT chat (your old code)
    // ... keep your fetch /api/chat code here
  }

  saveAll();
  updateProStatus();
}

// Keep your Pro unlock + status code from before

// Intro
addMessage("Hey! I'm NovaHoyaAI ðŸš€ Ready for a new chat? Use â˜° menu for history!", "bot");

input.focus();