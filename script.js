// script.js - THIS ONE WORKS 100% (images will finally appear)

window.addEventListener('puter-ready', () => {
  console.log("Puter.js ready â€” Nova AI goated ðŸ”¥");

  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");

  function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = `message ${type}`;

    if (content instanceof HTMLImageElement) {
      content.alt = "Generated by Nova AI with FLUX";
      content.loading = "lazy";
      content.style.maxWidth = "100%";
      content.style.borderRadius = "12px";
      content.style.marginTop = "10px";
      content.style.boxShadow = "0 4px 16px rgba(0,0,0,0.6)";
      div.appendChild(content);
    } else if (typeof content === "string") {
      div.innerHTML = content.replace(/\n/g, "<br>");
    }

    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";

    // LOOSE DETECTION - triggers on almost any creative prompt
    const lowerText = text.toLowerCase();
    const isImageRequest = text.length > 5 && (
      lowerText.includes("generate") || 
      lowerText.includes("create") || 
      lowerText.includes("draw") || 
      lowerText.includes("make") || 
      lowerText.includes("image") || 
      lowerText.includes("picture") || 
      lowerText.includes("banner") || 
      lowerText.includes("kingdom") || 
      lowerText.includes("city") || 
      lowerText.includes("cyberpunk") || 
      lowerText.includes("futuristic")
    );

    if (isImageRequest) {
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot";
      loadingDiv.innerText = "Generating your epic image with FLUX.1-schnell... ðŸ”¥ (5-20 sec)";
      chatArea.appendChild(loadingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      puter.ai.txt2img(text, {
        model: "black-forest-labs/FLUX.1-schnell"
      })
      .then((imageElement) => {
        chatArea.removeChild(loadingDiv);
        addMessage(imageElement, "bot");
      })
      .catch((err) => {
        chatArea.removeChild(loadingDiv);
        console.error(err);
        addMessage("Gen failed â€” try again or simpler prompt bro!", "bot");
      });

    } else {
      addMessage("Hey! I'm Nova AI ðŸš€\nTo generate images, just describe what you want (e.g. 'a cyberpunk kingdom at sunset')", "bot");
    }
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  addMessage("Yo! I'm Nova AI ðŸ”¥\nDescribe anything (like 'futuristic kingdom banner') and I'll generate a real FLUX image for you.", "bot");

  input.focus();
});