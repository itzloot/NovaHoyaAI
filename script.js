// script.js - FINAL FIXED VERSION (images will pop now)

window.addEventListener('puter-ready', () => {
  console.log("Puter.js ready â€” Nova AI locked and loaded ðŸ”¥");

  const input = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");

  function addMessage(content, type) {
    const div = document.createElement("div");
    div.className = `message ${type}`;

    if (content instanceof HTMLImageElement) {
      content.alt = "Generated by Nova AI with FLUX";
      content.loading = "lazy";
      content.style.maxWidth = "100%";
      content.style.borderRadius = "12px";
      content.style.marginTop = "10px";
      content.style.boxShadow = "0 4px 16px rgba(0,0,0,0.6)";
      div.appendChild(content);
    } else if (typeof content === "string") {
      // Simple markdown-like line breaks
      div.innerHTML = content.replace(/\n/g, "<br>");
    }

    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";

    // SUPER RELIABLE detection now
    const lowerText = text.toLowerCase();
    const isImageRequest = /generate|genrate|gemrate|create|draw|make|image|picture|photo|banner|flux|kingdom|city/i.test(lowerText);

    if (isImageRequest) {
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot";
      loadingDiv.innerText = "Cooking your image with FLUX.1-schnell... ðŸ”¥ (5-20 seconds)";
      chatArea.appendChild(loadingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      puter.ai.txt2img(text, {
        model: "black-forest-labs/FLUX.1-schnell"  // Fast & insane quality
      })
      .then((imageElement) => {
        chatArea.removeChild(loadingDiv);
        addMessage(imageElement, "bot");
      })
      .catch((err) => {
        chatArea.removeChild(loadingDiv);
        console.error(err);
        addMessage("Gen failed bro â€” try a simpler prompt or wait a sec!", "bot");
      });

    } else {
      addMessage("Yo! I'm Nova AI ðŸš€\nEdge computing + low-latency beast.\nNow with real FLUX image gen.\nJust include words like 'generate', 'create', or 'draw' in your prompt!", "bot");
    }
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  addMessage("Hey bro! I'm Nova AI.\nType something like:\n'generate a cyberpunk kingdom banner'\nor 'create a futuristic city at night'\nImages drop in seconds ðŸ”¥", "bot");

  input.focus();
});